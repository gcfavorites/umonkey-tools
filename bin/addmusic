#!/usr/bin/env python

"""Uploads music to tmradio.net"""

import os
import subprocess
import sys
import tempfile

DEFAULT_PATH = "cloud.umonkey.net:/radio/incoming/"
#DEFAULT_PATH = "tmradio:incoming/"

if __name__ == '__main__':
    fn = None
    command = [ 'sftp' ]

    if len(sys.argv) > 1:
        fn = tempfile.mkstemp(prefix='addmusic_', suffix='.txt')[1]
        fp = open(fn, 'wb')
        for item in sys.argv[1:]:
            item = item.replace(' ', '\\ ')
            item = item.replace('"', '\\"')
            item = item.replace("'", "\\'")
            print item
            fp.write('put %s\n' % item)
        fp.close()
        print 'Wrote batch to %s' % fn
        command.append('-b')
        command.append(fn)

    upload_path = os.environ.get("ARDJ_UPLOAD_PATH")
    if not upload_path:
        upload_path = DEFAULT_PATH
    command.append(upload_path)

    print "Uploading to %s" % upload_path

    subprocess.Popen(command).wait()
    if os.path.exists(fn):
        os.unlink(fn)

    subprocess.Popen(["notify-send", "addmusic", "%u files added." % (len(sys.argv) - 1)]).wait()

    sys.exit(0)
