#!/usr/bin/env python
# encoding=utf-8

import os
import subprocess
import sys
import tempfile

import mutagen
import mutagen.easyid3 as easyid3


def edit_tags(filename):
    tags = mutagen.File(filename, easy=True)
    text = u"\n".join(sorted([u"%s: %s" % (k, v[0]) for k, v in tags.items()]))

    tfname = filename + ".txt"
    file(tfname, "wb").write(text.encode("utf-8"))
    subprocess.Popen(["editor", tfname]).wait()

    for line in file(tfname, "rb").read().decode("utf-8").split("\n"):
        if line:
            try:
                tag, value = line.split(":", 1)
                tags[tag] = [value.strip()]
            except Exception, e:
                print >>sys.stderr, "Could not set a tag: %s" % e

    tags.save()
    os.unlink(tfname)


def process_file(filename):
    tmpname = tempfile.mktemp(suffix=".wav")
    print >>sys.stderr, "Resampling to %s" % tmpname

    command = ["sox", filename, "-r", "44100", "-c", "2", tmpname]
    if "--pad" in sys.argv:
        command.extend(["pad", "0.5", "0.5"])
    subprocess.Popen(command).wait()

    mp3name = os.path.splitext(filename)[0] + ".mp3"
    print >>sys.stderr, "Transcoding to %s" % mp3name
    subprocess.Popen(["lame", "--preset", "extreme", tmpname, mp3name]).wait()
    os.unlink(tmpname)

    edit_tags(mp3name)

    print >>sys.stderr, "Calculating ReplayGain for %s" % mp3name
    subprocess.Popen(["mp3gain", mp3name], stdout=subprocess.PIPE).wait()

    print >>sys.stderr, "Done."


if __name__ == "__main__":
    edit_only = "-e" in sys.argv
    easyid3.EasyID3.RegisterTXXXKey('ardj', 'ardj')
    for arg in sys.argv[1:]:
        if os.path.exists(arg):
            if edit_only:
                edit_tags(arg)
            else:
                process_file(arg)
